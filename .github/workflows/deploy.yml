name: Deploy to Lightsail

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST_IP }} >> ~/.ssh/known_hosts
    
    - name: Create project directory
      run: |
        ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.HOST_IP }} "
          sudo mkdir -p /var/www/autoplan.hyoda.kr
          sudo chown ubuntu:ubuntu /var/www/autoplan.hyoda.kr
        "
    
    - name: Sync files to server
      run: |
        rsync -avz -e 'ssh -i ~/.ssh/id_rsa' \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='*.md' \
          --exclude='cursor-*' \
          --exclude='tasks' \
          ./ ubuntu@${{ secrets.HOST_IP }}:/var/www/autoplan.hyoda.kr/
    
    - name: Setup Nginx and SSL
      run: |
        ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.HOST_IP }} "
          # Install nginx and certbot
          sudo apt-get update
          sudo apt-get install -y nginx certbot python3-certbot-nginx
          
          # Create nginx config
          echo 'server {
              listen 80;
              server_name autoplan.hyoda.kr;
              root /var/www/autoplan.hyoda.kr;
              index index.html;
          
              location / {
                  try_files \$uri \$uri/ =404;
              }
          
              add_header X-Frame-Options DENY;
              add_header X-Content-Type-Options nosniff;
              add_header X-XSS-Protection \"1; mode=block\";
              add_header Referrer-Policy \"strict-origin-when-cross-origin\";
          
              location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg)\$ {
                  expires 1y;
                  add_header Cache-Control \"public, immutable\";
              }
          }' | sudo tee /etc/nginx/sites-available/autoplan.hyoda.kr
          
          # Enable site
          sudo ln -sf /etc/nginx/sites-available/autoplan.hyoda.kr /etc/nginx/sites-enabled/
          
          # Test and reload nginx
          sudo nginx -t
          sudo systemctl reload nginx
          
          # Setup SSL
          sudo certbot --nginx -d autoplan.hyoda.kr --non-interactive --agree-tos --email admin@hyoda.kr --redirect
          
          # Final reload
          sudo systemctl reload nginx
        "